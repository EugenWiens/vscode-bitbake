{
    "$schema": "https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json",
    "scopeName": "source.bb",
    "name": "BitBake",
    "fileTypes": [
        "bb",
        "bbappend",
        "bbclass",
        "inc"
    ],
    "patterns": [
        {
            "include": "#comment"
        },
        {
            "include": "#variable-assignment"
        },
        {
            "include": "#variable-expansion"
        },
        {
            "include": "#directives"
        }
    ],
    "repository": {
        "string": {
            "patterns": [
                {
                    "name": "string.quoted.double.bb",
                    "begin": "(\")",
                    "beginCaptures": {
                        "1": {
                            "name": "punctuation.definition.string.begin.bb"
                        }
                    },
                    "end": "(\")",
                    "endCaptures": {
                        "1": {
                            "name": "punctuation.definition.string.end.bb"
                        }
                    },
                    "patterns": [
                        {
                            "include": "#escape"
                        },
                        {
                            "include": "#variable-expansion"
                        }
                    ]
                },
                {
                    "name": "string.quoted.single.bb",
                    "begin": "(')",
                    "beginCaptures": {
                        "1": {
                            "name": "punctuation.definition.string.begin.bb"
                        }
                    },
                    "end": "(')",
                    "endCaptures": {
                        "1": {
                            "name": "punctuation.definition.string.end.bb"
                        }
                    },
                    "patterns": [
                        {
                            "include": "#escape"
                        },
                        {
                            "include": "#variable-expansion"
                        }
                    ]
                }
            ]
        },
        "comment": {
            "match": "(^\\s*)((#)(.*))\\n",
            "captures": {
                "1": {
                    "name": "punctuation.whitespace.comment.leading.bb"
                },
                "2": {
                    "name": "comment.line.number-sign.bb"
                },
                "3": {
                    "name": "punctuation.definition.comment.bb"
                }
            }
        },
        "directives": {
            "patterns": [
                {
                    "match": "^\\s*(include)\\s+",
                    "captures": {
                        "1": {
                            "name": "keyword.control.include.bb"
                        }
                    }
                },
                {
                    "match": "^\\s*(require)\\s+",
                    "captures": {
                        "1": {
                            "name": "keyword.control.require.bb"
                        }
                    }
                },
                {
                    "match": "^\\s*(inherit)\\s+",
                    "captures": {
                        "1": {
                            "name": "keyword.control.inherit.bb"
                        }
                    }
                },
                {
                    "begin": "^\\s*(export)\\s+",
                    "beginCaptures": {
                        "1": {
                            "name": "keyword.control.export.bb"
                        }
                    },
                    "end": "^",
                    "patterns": [
                        {
                            "include": "#variable-assignment"
                        },
                        {
                            "include": "#variable-name"
                        }
                    ]
                },
                {
                    "match": "^\\s*(addtask)\\s+",
                    "captures": {
                        "1": {
                            "name": "keyword.control.addtask.bb"
                        }
                    }
                },
                {
                    "match": "\\s+(before)\\s+",
                    "captures": {
                        "1": {
                            "name": "keyword.control.before.bb"
                        }
                    }
                },
                {
                    "match": "\\s+(after)\\s+",
                    "captures": {
                        "1": {
                            "name": "keyword.control.after.bb"
                        }
                    }
                },
                {
                    "match": "^\\s*(deltask)\\s+",
                    "captures": {
                        "1": {
                            "name": "keyword.control.deltask.bb"
                        }
                    }
                },
                {
                    "begin": "^\\s*(fakeroot)?\\s+(python)\\s+([\\w\\-:]+)*\\s*\\(([^()]*)\\)\\s*(\\{)",
                    "beginCaptures": {
                        "1": {
                            "name": "keyword.control.fakeroot.bb"
                        },
                        "2": {
                            "name": "storage.type.function.python.bb"
                        },
                        "3": {
                            "name": "entity.name.function.python.bb"
                        },
                        "4": {
                            "name": "variable.parameter.bb",
                            "patterns": [
                                {
                                    "match": "(,\\s*)",
                                    "captures": {
                                        "1": {
                                            "name": "punctuation.separator.arguments.bb"
                                        }
                                    }
                                }
                            ]
                        },
                        "5": {
                            "name": "punctuation.definition.python-function.bb"
                        }
                    },
                    "end": "(\\})",
                    "endCaptures": {
                        "1": {
                            "name": "punctuation.definition.python-function.bb"
                        }
                    },
                    "patterns": [
                        {
                            "include": "source.python"
                        }
                    ]
                },
                {
                    "begin": "^\\s*(fakeroot)?\\s+(def)\\s+([\\w\\-:]+)*\\s*\\(([^()]*)\\)\\s*(\\:)",
                    "beginCaptures": {
                        "1": {
                            "name": "keyword.control.fakeroot.bb"
                        },
                        "2": {
                            "name": "storage.type.function.python.bb"
                        },
                        "3": {
                            "name": "entity.name.function.python.bb"
                        },
                        "4": {
                            "name": "variable.parameter.bb",
                            "patterns": [
                                {
                                    "match": "(,\\s*)",
                                    "captures": {
                                        "1": {
                                            "name": "punctuation.separator.arguments.bb"
                                        }
                                    }
                                }
                            ]
                        },
                        "5": {
                            "name": "punctuation.definition.python-function.bb"
                        }
                    },
                    "end": "(?=^\\S)",
                    "patterns": [
                        {
                            "include": "source.python"
                        }
                    ]
                },
                {
                    "begin": "^\\s*(fakeroot)?\\s+([\\w\\-:${}]+)\\s*(\\(\\))?\\s*(\\{)",
                    "beginCaptures": {
                        "1": {
                            "name": "keyword.control.fakeroot.bb"
                        },
                        "2": {
                            "name": "entity.name.function.shell.bb"
                        },
                        "4": {
                            "name": "punctuation.definition.shell-function.bb"
                        }
                    },
                    "end": "(\\})",
                    "endCaptures": {
                        "1": {
                            "name": "punctuation.definition.shell-function.bb"
                        }
                    },
                    "patterns": [
                        {
                            "include": "source.shell"
                        }
                    ]
                }
            ]
        },
        "variable-assignment": {
            "begin": "\\s*([\\w\\-:${}\\[\\]]+)\\s*(=|\\?=|\\?\\?=|:=|\\+=|=\\+|\\.=|=\\.)\\s*",
            "beginCaptures": {
                "1": {
                    "patterns": [
                        {
                            "name": "punctuation.separator.variable",
                            "match": ":"
                        },
                        {
                            "include": "#variable-name"
                        },
                        {
                            "include": "#variable-expansion"
                        }
                    ]
                },
                "2": {
                    "name": "keyword.operator.assignment.bb"
                }
            },
            "end": "\\n",
            "patterns": [
                {
                    "include": "#escape"
                },
                {
                    "include": "#variable-expansion"
                },
                {
                    "include": "#string"
                }
            ]
        },
        "variable-expansion": {
            "patterns": [
                {
                    "match": "(\\${)([\\w\\-]*)(})",
                    "captures": {
                        "1": {
                            "name": "punctuation.definition.template-expression.begin.bb"
                        },
                        "2": {
                            "patterns": [
                                {
                                    "include": "#variable-name"
                                }
                            ]
                        },
                        "3": {
                            "name": "punctuation.definition.template-expression.end.bb"
                        }
                    }
                },
                {
                    "match": "(\\${)((\\@)(.*)(\\()([^()]*)(\\)))(})",
                    "captures": {
                        "1": {
                            "name": "punctuation.definition.template-expression.begin.bb"
                        },
                        "2": {
                            "name": "meta.embedded.line.bb"
                        },
                        "3": {
                            "name": "support.constant.bb"
                        },
                        "4": {
                            "name": "support.function.bb"
                        },
                        "5": {
                            "name": "punctuation.definition.parameters.begin.bb"
                        },
                        "6": {
                            "name": "variable.parameter.bb",
                            "patterns": [
                                {
                                    "match": "(,\\s*)",
                                    "name": "punctuation.separator.arguments.bb"
                                },
                                {
                                    "include": "#string"
                                }
                            ]
                        },
                        "7": {
                            "name": "punctuation.definition.parameters.end.bb"
                        },
                        "8": {
                            "name": "punctuation.definition.template-expression.end.bb"
                        }
                    }
                }
            ]

        },
        "variable-name": {
            "name": "variable.name.bb",
            "match": "[\\w\\-]+"
        },
        "escape": {
            "name": "constant.character.escape.continuation.bb",
            "match": "(\\\\)(.|\\n)"
        }
    }
}
